/* ======================================
 * Title: Data Viz
 * Author: Erik & Alisen Hazzard
 * ====================================== */
var DECKVIZ,_this=this;DECKVIZ=function(){var a,b,c,d,e,f,g,h;return e={},d={},b={},a={},c={},f={},g=function(){return!0},h={capitalize:function(a){return a.charAt(0).toUpperCase()+a.substring(1)}},{Views:e,Models:d,Collections:b,Charts:a,Deck:c,init:g,util:h}}();var _this=this;DECKVIZ.util.convertedManaCost=function(a){var b;return a===null||a===void 0?null:(typeof a=="number"&&(a=""+a+""),a=a.replace(/X/gi,""),b=parseInt(a,10)||0,b+=(a.match(/[UWBRG]/gi)||[]).length,b-=(a.match(/\([^pP]\/[^pP]\)/gi)||[]).length,b)},DECKVIZ.util.colorScale={R:"#ff0000",G:"#00ff00",B:"#000000",U:"#0000ff",W:"#D6AC51",X:"#707070"};var _this=this;DECKVIZ.Charts.Cards=function(){var a,b,c;return c=$("#svg-el").attr("width"),b=$("#svg-el").attr("height"),a={R:"#ff0000",G:"#00ff00",B:"#000000",U:"#0000ff",W:"#D6AC51",X:"#707070"},d3.json("/items/setText=ISD|M13|DKA|AVR&sort=color,manacost/",function(d){var e,f,g,h;return h=d3.scale.linear().domain([0,18]).range([0,b]),g=d3.scale.ordinal().domain(d3.range(d.cards.length)).rangeBands([0,c],.2),f=function(a){var b,c;return b=!1,a.match(/X/gi)&&(b=!0),c=parseInt(a,10),c+=(a.match(/[UWBRGX]/gi)||[]).length,b&&(c*=-1),c},e=d3.select("#svg-el").selectAll("rect.bars").data(d.cards).enter().append("rect").attr("class","bars").attr("width",function(a,b){return g.rangeBand()}).attr("height",function(a,b){return h(f(a.manacost||"0"))}).attr("fill",function(b,c){return a[b.color||"X"]}).attr("transform",function(a,c){var d,e;return d=g(c),e=b-h(f(a.manacost||"0")),"translate("+[d,e]+")"}).on("mouseover",function(a,b){return console.log(a.manacost,a.color,a.name,a.type,a)})}),!0};var _this=this;DECKVIZ.Deck.getDeckFromInput=function(a){var b,c,d,e,f,g,h,i;if(!a)return!1;a=a||{},a.el&&(f=el.val()),a.deckText&&(f=a.deckText),e=f.split("\n"),d={};for(h=0,i=e.length;h<i;h++)c=e[h],g=parseInt(c.replace(/[^0-9 ]/gi,""),10),b=c.replace(/[0-9]+ */gi,""),d[b]=g;return d},DECKVIZ.Deck.getCardTypes=function(a){var b,c,d,e,f;c={},a=a||{};if(!a.deck)return!1;f=a.deck;for(d=0,e=f.length;d<e;d++)b=f[d],c[b.type]!=null?c[b.type]+=1:c[b.type]=0;return c},$("#deck").on("keyup",function(a){return DECKVIZ.Deck.create(DECKVIZ.Deck.getDeckFromInput({deckText:$("#deck").val()}))}),$("#deck").val("2 Tamiyo, the Moon Sage\n3 Entreat the Angels\n4 Terminus\n4 Lingering Souls\n1 Isolated Chapel\n1 Spellskite\n3 Dismember\n4 Pristine Talisman\n1 White Sun's Zenith\n4 Seachrome Coast\n3 Gideon Jura\n2 Day of Judgment\n4 Glacial Fortress\n4 Drowned Catacomb\n3 Oblivion Ring\n4 Think Twice\n4 Ghost Quarter\n1 Swamp\n3 Island\n5 Plains"),DECKVIZ.Deck.create=function(a){var b,c,d,e,f;a||(a=DECKVIZ.Deck.getDeckFromInput({deckText:$("#deck").val()})),f=[];for(b in a)d=a[b],f.push("^"+b+"$");return e="/items/name="+f.join("|"),c=[],$.ajax({url:e,success:function(b){var d,e,f,g,h,i,j;i=b.cards;for(g=0,h=i.length;g<h;g++){d=i[g];for(f=0,j=a[d.name]-1;0<=j?f<=j:f>=j;0<=j?f++:f--)c.push(d)}return e=DECKVIZ.Deck.getCardTypes({deck:c}),console.log(JSON.stringify(e)),DECKVIZ.Deck.manaCurve(c,a)}})},DECKVIZ.Deck.manaCurve=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A;r="#svg-el-deck-mana",$(r).empty(),u=$(r).attr("width"),h=$(r).attr("height"),l=10,p=[10,0,0,50],c=DECKVIZ.util.convertedManaCost,k={},t=[];for(z=0,A=a.length;z<A;z++)d=a[z],k[c(d.manacost)]?k[c(d.manacost)]+=1:k[c(d.manacost)]=1,d.manacost&&t.push(d);f=_.clone(a),a=t,j=[],m=0;for(g in k)n=k[g],g!=null&&parseInt(g)&&(j.push([g,n]),n>m&&(m=n));return console.log(m),v=d3.scale.linear().domain([0,l]).range([p[3],u]),o=h,h-=100,i=20,m>20&&(i=m*1.2),y=d3.scale.linear().domain([0,i]).rangeRound([p[0],h]),q=d3.select(r),e=q.selectAll("rect").data(j).enter(),console.log(j),e.append("rect").attr("x",function(a,b){return v(a[0])-.5}).attr("width",function(a,b){return u/(l+2)}).style("fill",function(a,b){return DECKVIZ.util.colorScale.X}).attr("y",function(a){return h}).attr("height",function(a){return 0}).transition().attr("height",function(a){return y(a[1])-.5}).attr("y",function(a){return h-y(a[1])-.5}),e.append("text").text(function(a,b){return a[1]}).attr("x",function(a,b){return v(a[0])-5+u/(l+2)/2}).attr("y",h-15).style("fill","#ffffff").style("text-shadow","0 -1px 2px #000000"),q.selectAll("text.label").data(function(){var a;a=[];for(n=0;0<=l?n<=l:n>=l;0<=l?n++:n--)a.push(n);return a}()).enter().append("svg:text").attr("class","label").attr("x",function(a,b){return v(a)-.5+u/(l+2)/2}).attr("y",h+20).text(function(a,b){return a}),q.append("line").attr("x1",p[3]).attr("x2",u).attr("y1",h-.5).attr("y2",h-.5).style("stroke","#000"),s=d3.scale.linear().domain([i,0]).rangeRound([p[0],h]),w=d3.svg.axis().scale(s).ticks(9).orient("left"),x=q.append("g").attr("transform","translate("+[p[3],0]+")").classed("yaxis",!0).call(w),x.selectAll("path").style("fill","none").style("stroke","#000"),x.selectAll("line").style("fill","none").style("stroke","#000"),!0},DECKVIZ.Deck.deckPie=function(a,b){var c,d,e,f,g;return f="#svg-el-deck-pie",$(f).empty(),g=$(f).attr("width"),c=$(f).attr("height"),e=d3.select(f),d=d3.layout.pie};