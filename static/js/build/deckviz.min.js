/* ======================================
 * Title: Data Viz
 * Author: Erik & Alisen Hazzard
 * ====================================== */
var DECKVIZ,_this=this;DECKVIZ=function(){var a,b,c,d,e,f,g,h;return e={},d={},b={},a={},c={},f={},g=function(){return!0},h={capitalize:function(a){return a.charAt(0).toUpperCase()+a.substring(1)}},{Views:e,Models:d,Collections:b,Charts:a,Deck:c,init:g,util:h}}(),window.DECKVIZ=DECKVIZ,DECKVIZ.init=function(){return DECKVIZ.Deck.create(),!0};var _this=this;DECKVIZ.util.calculateCardManaCost=function(a){var b;return a===null||a===void 0?null:(typeof a=="number"&&(a=""+a+""),a=a.replace(/X/gi,""),b=parseInt(a,10)||0,b+=(a.match(/[UWBRG]/gi)||[]).length,b-=(a.match(/\([^pP]\/[^pP]\)/gi)||[]).length,b)},DECKVIZ.util.colorScale={R:"#E33939",G:"#78dd60",B:"#404040",U:"#5d9cdd",W:"#fffacf",X:"#CBD5F2",C:"#909090"};var _this=this;DECKVIZ.Charts.Cards=function(){var a,b,c;return c=$("#svg-el").attr("width"),b=$("#svg-el").attr("height"),a={R:"#ff0000",G:"#00ff00",B:"#000000",U:"#0000ff",W:"#D6AC51",X:"#707070"},d3.json("/items/setText=ISD|M13|DKA|AVR&sort=color,manacost/",function(d){var e,f,g,h;return h=d3.scale.linear().domain([0,18]).range([0,b]),g=d3.scale.ordinal().domain(d3.range(d.cards.length)).rangeBands([0,c],.2),f=function(a){var b,c;return b=!1,a.match(/X/gi)&&(b=!0),c=parseInt(a,10),c+=(a.match(/[UWBRGX]/gi)||[]).length,b&&(c*=-1),c},e=d3.select("#svg-el").selectAll("rect.bars").data(d.cards).enter().append("rect").attr("class","bars").attr("width",function(a,b){return g.rangeBand()}).attr("height",function(a,b){return h(f(a.manacost||"0"))}).attr("fill",function(b,c){return a[b.color||"X"]}).attr("transform",function(a,c){var d,e;return d=g(c),e=b-h(f(a.manacost||"0")),"translate("+[d,e]+")"}).on("mouseover",function(a,b){return console.log(a.manacost,a.color,a.name,a.type,a)})}),!0};var _this=this;DECKVIZ.Deck.getDeckFromInput=function(a){var b,c,d,e,f,g,h,i;if(!a)return!1;a=a||{},a.el&&(f=el.val()),a.deckText&&(f=a.deckText),f?e=f.split("\n"):(f="",e=!1),d={};if(e)for(h=0,i=e.length;h<i;h++)c=e[h],g=parseInt(c.replace(/[^0-9 ]/gi,""),10),b=c.replace(/[0-9]+ */gi,""),d[b]=g;return d},DECKVIZ.Deck.getCardTypes=function(a){var b,c,d,e,f;c={},a=a||{};if(!a.deck)return console.log("No deck passed in!"),!1;f=a.deck;for(d=0,e=f.length;d<e;d++)b=f[d],c[b.type]!=null?c[b.type]+=1:c[b.type]=1;return c},$("#deck").on("keyup",function(a){return DECKVIZ.Deck.create(DECKVIZ.Deck.getDeckFromInput({deckText:$("#deck").val()}),!0)}),$("#deck").val("2 Pillar of Flame\n4 Huntmaster of the Fells\n2 Kessig Wolf Run\n1 Devil's Play\n1 Whipflare\n2 Green Sun's Zenith\n4 Sphere of the Suns\n3 Inkmoth Nexus\n4 Slagstorm\n1 Wurmcoil Engine\n2 Galvanic Blast\n4 Copperline Gorge\n4 Glimmerpost\n1 Inferno Titan\n4 Primeval Titan\n1 Acidic Slime\n4 Rootbound Crag\n3 Solemn Simulacrum\n4 Mountain\n5 Forest\n4 Rampant Growth\n1 Birds of Paradise"),DECKVIZ.Deck.create=function(a){var b,c,d,e,f,g,h;a||(d=$("#deck").val(),a=DECKVIZ.Deck.getDeckFromInput({deckText:d}),c=DECKVIZ.Deck.getDeckFromInput({deckText:d})),h=[];for(b in a)f=a[b],h.push("^"+b+"$");return g="/items/name="+h.join("|"),e=[],$.ajax({url:g,success:function(b){var c,d,f,g,h,i,j;i=b.cards;for(g=0,h=i.length;g<h;g++){c=i[g];if(a[c.name]>0){for(f=0,j=a[c.name]-1;0<=j?f<=j:f>=j;0<=j?f++:f--)e.push(c);a[c.name]=-1}}return d=DECKVIZ.Deck.getCardTypes({deck:e}),DECKVIZ.Deck.drawManaCurve(e,a)}})},DECKVIZ.Deck.drawManaCurve=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q;D=d3.select("#svg-el-deck-mana"),$("#svg-defs").remove(),C=D.append("svg:defs").attr("id","svg-defs"),J=D.attr("width"),o=D.attr("height"),o-=100,y=7,B=[0,0,0,50],e=DECKVIZ.util.calculateCardManaCost,v={},i=[];for(O=0,P=a.length;O<P;O++){f=a[O],g=e(f.manacost),v[g]?v[g].total+=1:(v[g]={},v[g].total=1,g>y&&(y=g)),v[g].cost=g,v[g].type||(v[g].type={}),f.type&&(h=f.type.split(" - ")[0],v[g].type[h]?v[g].type[h]+=1:v[g].type[h]=1),n=f.manacost;if(n){l=parseInt(n,10),G="";if(l>0)for(q=0,Q=l-1;0<=Q?q<=Q:q>=Q;0<=Q?q++:q--)G+="C";l=G,n=n.replace(/^[0-9]*/,""),n=l+n,i.push(n),v[g].color||(v[g].color={}),v[g].color[n]?v[g].color[n]+=1:v[g].color[n]=1}'WORKING - Group by Color \nif curManaCost\n    #Get all the colors\n    curManaCost = curManaCost.replace(/[^UWBRG]+/gi,\'\')\n    #Get the unique values (e.g., "GG" to "G")\n    #   Also sort so we get "GR" instead of "RG"\n    curManaCost = _.unique(curManaCost.split(\'\').sort()).join(\'\')\n\n    if curManaCost.length > 0\n        #Colored spell (might be multicolored)\n        curManaCost = curManaCost\n    else\n        #Colorless spell (PROBABLY, need to check)\n        curManaCost = \'X\'\n\n    #Make sure the color object exists\n    if !manaCostLookup[cardCost].color\n        manaCostLookup[cardCost].color = {}\n\n    #Add mana key and count to lookup dict\n    #   e.g., "G": 1\n    if manaCostLookup[cardCost].color[curManaCost]\n        manaCostLookup[cardCost].color[curManaCost] += 1\n    else\n        manaCostLookup[cardCost].color[curManaCost] = 1'}w=[];for(r in v)H=v[r],w.push(H);i=_.unique(i),k=d3.layout.stack()(i.map(function(a){var b,c,d,e,f,g;d=C.append("svg:linearGradient").attr("id","gradient-"+a),c=a.split("("),c=c[0].split(""),q=0;for(f=0,g=c.length;f<g;f++)b=c[f],d.append("svg:stop").attr("offset",100/c.length*q+"%").attr("stop-color",DECKVIZ.util.colorScale[b]).attr("stop-opacity",1),d.append("svg:stop").attr("offset",100/c.length*(q+1)-2+"%").attr("stop-color",DECKVIZ.util.colorScale[b]).attr("stop-opacity",1),q++;return e=w.map(function(b){var c,d;return d=0,b.color&&b.color[a]&&(d=b.color[a]),c=b.cost||-1,{x:c,y:d,color:a}}),e})),y+=1,u=[],z=0;for(m in v)I=v[m],m!=null&&parseInt(m)&&(u.push([m,I.total]),I.total>z&&(z=I.total));return p=20,z>20&&(p=z*1.15),K=d3.scale.linear().rangeRound([B[3],J]).domain([0,y]),N=d3.scale.linear().rangeRound([0,o]).domain([0,p]),d=d3.select("#manaCurve"),c=1.5,j=d.selectAll("g.color").data(k),j.enter().append("svg:g").attr("class","color"),j.exit().remove(),s=j.selectAll("rect.cardBar").data(function(a){return a}),s.enter().append("svg:rect").attr("x",function(a){return K(a.x)}).attr("y",o).attr("height",0).attr("class","cardBar").attr("width",J/(y+c)),s.exit().transition().duration(300).ease("circle").attr("y",o).attr("height",0).remove(),E=s.transition().duration(250).ease("quad").attr("x",function(a){return K(a.x)}).attr("y",function(a){return o-N(a.y0)-N(a.y)}).attr("height",function(a){return a.y<1?0:N(a.y)}).attr("width",J/(y+c)),E.style("stroke","#000000").style("stroke-width","1").style("stroke-opacity",.7),E.style("fill",function(a){return"url(#gradient-"+a.color+")"}),t=d.selectAll("text").data(u),t.enter().append("text").style("fill","#000000").style("text-shadow","0 0 1px #ffffff").style("opacity",.3).attr("x",function(a,b){return K(a[0])-5+J/(y+c)/2}).attr("y",function(a,b){return o}),t.exit().transition().duration(300).ease("circle").attr("y",o).attr("height",0).text("0").remove(),t.transition().duration(250).ease("quad").text(function(a,b){return a[1]}).attr("x",function(a,b){return K(a[0])-5+J/(y+c)/2}).attr("y",function(a,b){return o-N(a[1])-5}),D=d3.select("#axesLabels"),$(D.node()).empty(),D=D.append("g").attr("class","axesGroup"),D.selectAll("text.label").data(function(){var a,b;b=[];for(A=0,a=y-1;0<=a?A<=a:A>=a;0<=a?A++:A--)b.push(A);return b}()).enter().append("svg:text").attr("class","label").attr("x",function(a,b){return K(a)-.5+J/(y+c)/2}).attr("y",o+20).text(function(a,b){return a}),D.append("line").attr("x1",B[3]).attr("x2",J).attr("y1",o-.5).attr("y2",o-.5).style("stroke","#000"),F=d3.scale.linear().domain([p,0]).range([0,o]),L=d3.svg.axis().scale(F).ticks(9).orient("left"),M=D.append("g").attr("transform","translate("+[B[3],0]+")").classed("yaxis",!0).call(L),M.selectAll("path").style("fill","none").style("stroke","#000"),M.selectAll("line").style("fill","none").style("stroke","#000"),x=d3.select("#manaCurveViz"),x.attr("transform")||x.attr("transform","translate(0,30)"),!0},DECKVIZ.Deck.deckPie=function(a,b){var c,d,e,f,g;return f="#svg-el-deck-pie",$(f).empty(),g=$(f).attr("width"),c=$(f).attr("height"),e=d3.select(f),d=d3.layout.pie};