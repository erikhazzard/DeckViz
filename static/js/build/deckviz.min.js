/* ======================================
 * Title: Data Viz
 * Author: Erik & Alisen Hazzard
 * ====================================== */
var DECKVIZ,_this=this;DECKVIZ=function(){var a,b,c,d,e,f,g,h;return e={},d={},b={},a={},c={},f={},g=function(){return!0},h={capitalize:function(a){return a.charAt(0).toUpperCase()+a.substring(1)}},{Views:e,Models:d,Collections:b,Charts:a,Deck:c,init:g,util:h}}(),window.DECKVIZ=DECKVIZ,DECKVIZ.init=function(){return DECKVIZ.Deck.create(),!0};var _this=this;DECKVIZ.util.calculateCardManaCost=function(a){var b;return a===null||a===void 0?null:(typeof a=="number"&&(a=""+a+""),a=a.replace(/X/gi,""),b=parseInt(a,10)||0,b+=(a.match(/[UWBRG]/gi)||[]).length,b-=(a.match(/\([^pP]\/[^pP]\)/gi)||[]).length,b)},DECKVIZ.util.colorScale={R:"#ff0000",G:"#00ff00",B:"#000000",U:"#0000ff",W:"#D6AC51",X:"#707070"};var _this=this;DECKVIZ.Charts.Cards=function(){var a,b,c;return c=$("#svg-el").attr("width"),b=$("#svg-el").attr("height"),a={R:"#ff0000",G:"#00ff00",B:"#000000",U:"#0000ff",W:"#D6AC51",X:"#707070"},d3.json("/items/setText=ISD|M13|DKA|AVR&sort=color,manacost/",function(d){var e,f,g,h;return h=d3.scale.linear().domain([0,18]).range([0,b]),g=d3.scale.ordinal().domain(d3.range(d.cards.length)).rangeBands([0,c],.2),f=function(a){var b,c;return b=!1,a.match(/X/gi)&&(b=!0),c=parseInt(a,10),c+=(a.match(/[UWBRGX]/gi)||[]).length,b&&(c*=-1),c},e=d3.select("#svg-el").selectAll("rect.bars").data(d.cards).enter().append("rect").attr("class","bars").attr("width",function(a,b){return g.rangeBand()}).attr("height",function(a,b){return h(f(a.manacost||"0"))}).attr("fill",function(b,c){return a[b.color||"X"]}).attr("transform",function(a,c){var d,e;return d=g(c),e=b-h(f(a.manacost||"0")),"translate("+[d,e]+")"}).on("mouseover",function(a,b){return console.log(a.manacost,a.color,a.name,a.type,a)})}),!0};var _this=this;DECKVIZ.Deck.getDeckFromInput=function(a){var b,c,d,e,f,g,h,i;if(!a)return!1;a=a||{},a.el&&(f=el.val()),a.deckText&&(f=a.deckText),e=f.split("\n"),d={};for(h=0,i=e.length;h<i;h++)c=e[h],g=parseInt(c.replace(/[^0-9 ]/gi,""),10),b=c.replace(/[0-9]+ */gi,""),d[b]=g;return d},DECKVIZ.Deck.getCardTypes=function(a){var b,c,d,e,f;c={},a=a||{};if(!a.deck)return console.log("No deck passed in!"),!1;f=a.deck;for(d=0,e=f.length;d<e;d++)b=f[d],c[b.type]!=null?c[b.type]+=1:c[b.type]=1;return c},$("#deck").on("keyup",function(a){return DECKVIZ.Deck.create(DECKVIZ.Deck.getDeckFromInput({deckText:$("#deck").val()}),!0)}),$("#deck").val("2 Tamiyo, the Moon Sage\n3 Entreat the Angels\n4 Terminus\n4 Lingering Souls\n1 Isolated Chapel\n1 Spellskite\n3 Dismember\n4 Pristine Talisman\n1 White Sun's Zenith\n4 Seachrome Coast\n3 Gideon Jura\n2 Day of Judgment\n4 Glacial Fortress\n4 Drowned Catacomb\n3 Oblivion Ring\n4 Think Twice\n4 Ghost Quarter\n1 Swamp\n3 Island\n5 Plains"),DECKVIZ.Deck.create=function(a){var b,c,d,e,f,g,h;a||(d=$("#deck").val(),a=DECKVIZ.Deck.getDeckFromInput({deckText:d}),c=DECKVIZ.Deck.getDeckFromInput({deckText:d})),h=[];for(b in a)f=a[b],h.push("^"+b+"$");return g="/items/name="+h.join("|"),e=[],$.ajax({url:g,success:function(b){var c,d,f,g,h,i,j;i=b.cards;for(g=0,h=i.length;g<h;g++){c=i[g];if(a[c.name]>0){for(f=0,j=a[c.name]-1;0<=j?f<=j:f>=j;0<=j?f++:f--)e.push(c);a[c.name]=-1}}return d=DECKVIZ.Deck.getCardTypes({deck:e}),DECKVIZ.Deck.drawManaCurve(e,a)}})},DECKVIZ.Deck.drawManaCurve=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B;s=d3.select("#svg-el-deck-mana"),v=s.attr("width"),j=s.attr("height"),o=7,r=[10,0,0,50],e=DECKVIZ.util.calculateCardManaCost,n={},u=[];for(A=0,B=a.length;A<B;A++)f=a[A],g=e(f.manacost),n[g]?n[g]+=1:(n[g]=1,g>o&&(o=g)),f.manacost&&u.push(f);o+=2,h=_.clone(a),a=u,m=[],p=0;for(i in n)q=n[i],i!=null&&parseInt(i)&&(m.push([i,q]),q>p&&(p=q));return j-=100,k=20,p>20&&(k=p*1.2),w=d3.scale.linear().domain([0,o]).range([r[3],v]),z=d3.scale.linear().domain([0,k]).rangeRound([r[0],j]),d=d3.select("#manaCurve"),c=1.5,l=d.selectAll("rect").data(m),l.enter().append("rect").style("fill","#ffffff").attr("x",function(a,b){return w(a[0])-.5}).attr("width",function(a,b){return v/(o+c)}).attr("height",function(a){return 0}).attr("y",function(a){return j}),l.exit().transition().duration(300).ease("circle").attr("y",j).attr("height",0).remove(),l.transition().duration(250).ease("quad").style("fill",function(a,b){return DECKVIZ.util.colorScale.X}).attr("width",function(a,b){return v/(o+c)}).attr("y",function(a,b){return j-z(a[1])-.5}).attr("x",function(a,b){return w(a[0])-.5}).attr("height",function(a,b){return z(a[1])-.5}),"manaBars.append('text')\n    .text((d,i)=>\n        return d[1]\n    )\n    .attr(\"x\", (d,i)=>\n        return (xScale(d[0]) - 5) + ((width/(maxManaCost + barSpacingFactor))/2)\n    ).attr(\"y\", height - 15)\n    .style('fill', '#ffffff')\n    .style('text-shadow', '0 -1px 2px #000000')",s=d3.select("#axesLabels"),$(s.node()).empty(),s.selectAll("text.label").data(function(){var a;a=[];for(q=0;0<=o?q<=o:q>=o;0<=o?q++:q--)a.push(q);return a}()).enter().append("svg:text").attr("class","label").attr("x",function(a,b){return w(a)-.5+v/(o+c)/2}).attr("y",j+20).text(function(a,b){return a}),s.append("line").attr("x1",r[3]).attr("x2",v).attr("y1",j-.5).attr("y2",j-.5).style("stroke","#000"),t=d3.scale.linear().domain([k,0]).rangeRound([r[0],j]),x=d3.svg.axis().scale(t).ticks(9).orient("left"),y=s.append("g").attr("transform","translate("+[r[3],0]+")").classed("yaxis",!0).call(x),y.selectAll("path").style("fill","none").style("stroke","#000"),y.selectAll("line").style("fill","none").style("stroke","#000"),!0},DECKVIZ.Deck.deckPie=function(a,b){var c,d,e,f,g;return f="#svg-el-deck-pie",$(f).empty(),g=$(f).attr("width"),c=$(f).attr("height"),e=d3.select(f),d=d3.layout.pie};