/* ======================================
 * Title: Lucid UI
 * Author: Erik Hazzard
 * ====================================== */
LUCID=function(){var a={},b={},c={},d={},e={},f=!1,g={capitalize:function(a){return a.charAt(0).toUpperCase()+a.substring(1)}},h={};return{Views:a,Models:b,Collections:c,facetObjects:h,app:d,appView:e,init:f,util:g}}(),LUCID.Views.Facet=Backbone.View.extend({tagName:"div",className:"facet-wrapper",settingsView:!1,events:{"click .facet-header":"toggleFacetSettings"},initialize:function(){return this.settingsView=LUCID.facetObjects.viewFactory(this.model),this.model.on("change",this.updateHeader,this),this},render:function(){var a=_.template($("#template-facet-wrapper").html())({model:this.model});return this.$el.empty(),this.$el.append($(a)),$(".facet-settings",this.$el).append(this.settingsView.render()),this.showHideView(),$(".facet-header",this.$el).prop("rel")===undefined&&($(".facet-header",this.$el).prop({rel:"tooltip"}),$(".facet-header",this.$el).popover({title:this.model.get("title"),content:this.model.get("description")})),this.$el},updateHeader:function(){return $(".title",this.$el).html(this.model.get("title")),this.model.get("numResults")>-1?$(".num-results",this.$el).html(this.model.get("numResults")+" items"):$(".num-results",this.$el).html(""),this},showHideView:function(){return this.model.get("active")===!0?this.$el.css({display:"block"}):this.$el.css({display:"none"}),this},toggleFacetSettings:function(){return this.$el.hasClass("open")?this.$el.removeClass("open"):this.$el.addClass("open"),this}}),LUCID.Models.Facet=Backbone.Model.extend({defaults:{active:!1,title:"Facet Title",name:"facet",currentValue:"All",description:"Some description about this facet",numResults:"",facetSettingsHtml:"",fields:undefined},initialize:function(){this.on("change:fields",this.fieldsUpdated,this),this.on("fetchedFields",this.fetchedFields,this)},fieldsUpdated:function(){var a=this.get("fields"),b,c=[],d=0;for(b in a)a.hasOwnProperty(b)&&a[b].active===!0&&(c.push(b),d+=a[b].count);return c=c.join(","),this.set({currentValue:c,numResults:d}),this},fetchedFields:function(a){var b={},c,d,e,f;f=["categories","topics"];for(d in f)if(f.hasOwnProperty(d)){e=f[d];if(this.get("name")===e){b=this.get("fields");for(c in b)b.hasOwnProperty(c)&&(b[c].count=a.facets[e][c]);this.set({fields:b})}}},deactivateFields:function(){var a=this.get("fields"),b;if(a)for(b in a)a.hasOwnProperty(b)&&(a[b].active=!1);return this.set({fields:a,currentValue:""},{silent:!0}),this.trigger("change:fields"),this.trigger("change:currentValue"),this}}),LUCID.Views.Facets=Backbone.View.extend({el:".facets-list-wrapper",events:{},views:{},initialize:function(){return this.collection.on("add",this.createView,this),this},render:function(){var a,b={};for(a in LUCID.facetObjects.models)LUCID.facetObjects.models.hasOwnProperty(a)&&this.collection.add(LUCID.facetObjects.models[a],b);return this},createView:function(a,b){a===undefined&&console.log("No model passed into createView()");var c=!0;a.get("name")==="search"&&(c=!1);var d=new LUCID.Views.Facet({model:a});this.views["view_"+a.cid]=d,c===!0?this.$el.append(d.render()):d.render(),a.set({active:!0})}}),LUCID.Collections.Facets=Backbone.Collection.extend({model:LUCID.Models.Facet,initialize:function(){this.on("updateCollectionCount",this.updateCollectionCount),this.updateCollectionCount()},generateUrl:function(){var a=[],b,c=this.models,d=c.length,e,f;for(f=d-1;f>=0;f--)e=c[f],b=e.get("currentValue"),b&&b.length>0&&(b=encodeURIComponent(b),a.push(e.get("name")+"="+b));return a=a.join("&"),a},updateCollectionCount:function(){var a=this;$.ajax({url:"/facet_count/"+this.generateUrl(),dataType:"json",success:function(b){_.each(a.models,function(a){a.trigger("fetchedFields",b)})}})}}),LUCID.facetObjects=function(){var a={},b={},c=function(){},d=Backbone.View.extend({className:"inner",events:{},initalize:function(){},render:function(){var a=_.template($("#template-facet-settings-"+this.model.get("name")).html())({model:this.model});return this.$el.empty(),this.$el.append(a),this.$el}});return a.search=new LUCID.Models.Facet({name:"search",title:"Search",currentValue:"",description:"",active:!0}),b.search=Backbone.View.extend({el:".search",events:{"change .search-query":"updateInput"},initialize:function(){this.$searchInput=$("#facet-search")},render:function(){var a=this;this.$searchInput.autocomplete({source:function(a,b){$.ajax({url:"search_lookahead/",dataType:"json",data:{term:a.term},success:function(a){b($.map(a.terms,function(a){return{label:a,value:a}}))}})},minLength:2,select:function(b,c){a.model.set({currentValue:c.item.value})}})},updateInput:function(a){this.model.set({currentValue:this.$searchInput.val()})}}),a.date=new LUCID.Models.Facet({name:"date",title:"Date Range",currentValue:"",description:"Limits search results by a range of dates",active:!0}),b.date=Backbone.View.extend({className:"inner",events:{"change #facet-date-begin":"changeDate","change #facet-date-end":"changeDate"},initalize:function(){},render:function(){var a=this,b=_.template($("#template-facet-settings-"+this.model.get("name")).html())({model:this.model});return this.$el.empty(),this.$el.append(b),$("input.date",this.$el).datetimepicker({changeMonth:!0,changeYear:!0}),this.$el},getTimes:function(){var a,b,c,d;return a=$("#facet-date-begin").val()||0,c=(new Date(a)).getTime()/1e3,b=$("#facet-date-end").val()||0,d=(new Date(b)).getTime()/1e3,{start:c,end:d}},changeDate:function(){var a=this.getTimes(),b="";a.start<1?b+="Beginning of Time":b+=$.datepicker.formatDate("yy-mm-dd",new Date(a.start*1e3)),b+=" until ",a.end<1?b+="End of Time":b+=$.datepicker.formatDate("yy-mm-dd",new Date(a.end*1e3)),this.model.set({currentValue:""+a.start+","+a.end,breadCrumbTitle:b})}}),a.categories=new LUCID.Models.Facet({name:"categories",title:"Categories",currentValue:"",description:"Limits search results by category",active:!0,fields:{Odin:{active:!1,count:0},Thor:{active:!1,count:0},Loki:{active:!1,count:0},Heimdall:{active:!1,count:0},Vidar:{active:!1,count:0},Njord:{active:!1,count:0}}}),b.categories=Backbone.View.extend({className:"inner",events:{},initialize:function(){this.model.on("change:fields",this.updateListElements,this),this.model.on("fetchedFields",this.updateFieldCount,this)},generateFieldHtml:function(){var a=this.model.get("fields"),b=[],c;for(c in a)a.hasOwnProperty(c)&&b.push("<li><span class='field-wrapper name-"+c.toLowerCase().replace(/[^a-z]/gi,"")+"'>"+c+"<span class='count'>("+a[c].count+")</span></span></li>");return b=b.join(""),b},updateFieldCount:function(){var a=this.model.get("fields"),b=[],c;for(c in a)a.hasOwnProperty(c)&&$(".field-wrapper.name-"+c.toLowerCase().replace(/[^a-z]/gi,"")+" .count").html("("+a[c].count+")")},render:function(){var a=this,b=this.generateFieldHtml(),c=_.template($("#template-facet-settings-"+this.model.get("name")).html())({model:this.model,fields:b});return this.$el.empty(),this.$el.append(c),$("li",this.$el).click(function(b){var c=a.model.get("fields"),d,e=$(b.currentTarget);d=$(".field-wrapper",e).html().match(/\w*/)[0],c[d].active===!0?c[d].active=!1:c[d].active=!0,a.model.set({fields:c},{silent:!0}),a.model.trigger("change:fields"),a.updateListElements()}),this.$el},updateListElements:function(){var a=this.model.get("fields");$("li",this.$el).each(function(b,c){var d=$(".field-wrapper",c).html().match(/\w*/)[0],e="";a[d].active===!0?$(c).addClass("active"):$(c).removeClass("active")})}}),a.topics=new LUCID.Models.Facet({name:"topics",title:"Topics",currentValue:"",description:"Limits search results by topic",active:!0,fields:{Auto:{active:!1,count:0},Business:{active:!1,count:0},Communication:{active:!1,count:0},Electronics:{active:!1,count:0},Internet:{active:!1,count:0},Television:{active:!1,count:0}}}),b.topics=Backbone.View.extend({className:"inner",events:{},initialize:b.categories.prototype.initialize,generateFieldHtml:b.categories.prototype.generateFieldHtml,render:b.categories.prototype.render,updateListElements:b.categories.prototype.updateListElements,updateFieldCount:b.categories.prototype.updateFieldCount}),c=function(a){var c;return b[a.get("name")]?c=new(b[a.get("name")])({model:a}):c=new d({model:a}),c},{models:a,viewFactory:c,views:b}}(),LUCID.Views.App=Backbone.View.extend({el:"#site-wrapper",optionsView:undefined,events:{"click .options-button-wrapper":"optionsButtonClicked"},initialize:function(){return this},render:function(){return this.optionsView=new LUCID.Views.AppOptions({el:this.$(".options-dialog-wrapper")}),$(".options-button").tooltip(),this},optionsButtonClicked:function(){return this.optionsView.$el.css("display")==="none"?(this.optionsView.render(),$(".options-button-wrapper .options-button").addClass("active")):(this.optionsView.unrender(),$(".options-button-wrapper .options-button").removeClass("active")),this}}),LUCID.Views.AppOptions=Backbone.View.extend({render:function(){this.$el.fadeIn()},unrender:function(){this.$el.fadeOut()}}),LUCID.Models.App=Backbone.Model.extend({defaults:{facets:{},dataItems:{}},initialize:function(){this.set({facets:new LUCID.Collections.Facets,dataItems:new LUCID.Collections.DataItems})}}),LUCID.Views.DataItem=Backbone.View.extend({tagName:"div",className:"data-item-wrapper",events:{},initialize:function(){return this.model.on("destroy",this.remove,this),this},render:function(){var a=[],b=this.model.attributes,c=this.model.defaults,d,e;for(d in b)b.hasOwnProperty(d)&&c[d]===undefined&&a.push("<div class='model-properties'><span class='key'>"+LUCID.util.capitalize(d)+"</span><span class='value'>"+b[d]+"</span>"+"</div>");return a=a.join(""),e=_.template($("#template-data-item").html())({model:this.model,modelProperties:a}),this.$el.empty(),this.$el.append($(e)),this.$el},unrender:function(){this.$el.remove()}}),LUCID.Models.DataItem=Backbone.Model.extend({defaults:{title:"Item Name",date:new Date,description:"Some description about this facet"}}),LUCID.Views.DataItems=Backbone.View.extend({el:".data-items",views:{},events:{},initialize:function(){return this.collection===undefined?(console.log("No collection passed into data item view"),!1):(this.collection.on("add",this.addItem,this),this.collection.on("remove",this.removeItem,this),this.collection.on("numResultsUpdated",this.updateDataItemsCount,this),this.collection.on("reset",this.resetItems,this),this.collection.on("reset",function(){this.updateDataItemsCount(0)},this),LUCID.app.get("facets")&&LUCID.app.get("facets").on("change",this.collection.updateCollection,this.collection),this)},render:function(){this.wrapper=this.wrapper||$(".data-items-wrapper"),this.$resultsCount=$(".data-items-total .total");var a=this;return this.collection.fetch({success:function(b,c){a.collection.numResults=c.num_results,a.collection.trigger("numResultsUpdated")},error:function(a){}}),this},unrender:function(){this.$el.empty()},resetItems:function(){this.unrender(),this.addAllItems()},addItem:function(a){return this.views["view-"+a.cid]=new LUCID.Views.DataItem({model:a}),this.$el.append(this.views["view-"+a.cid].render()),this},addAllItems:function(){return this.collection.each(this.addItem,this),this},removeItem:function(a){this.views["view-"+a.cid].unrender()},removeAllItems:function(){},updateDataItemsCount:function(a){return this.$resultsCount&&(a===undefined?this.$resultsCount.html(this.collection.numResults):this.$resultsCount.html(a)),this}}),LUCID.Collections.DataItems=Backbone.Collection.extend({model:LUCID.Models.DataItem,url:"items/",parse:function(a){return a.models},initialize:function(){this.numResults=0},generateUrl:function(){var a="items/",b=a+LUCID.app.get("facets").generateUrl();return b},getActiveItems:function(){},updateCollection:function(){this.url=this.generateUrl();var a=this;return this.fetch({success:function(b,c){a.numResults=c.num_results,a.trigger("numResultsUpdated")},error:function(a){}}),LUCID.app.get("facets").trigger("updateCollectionCount"),this}}),LUCID.facetObjects=function(){var a={},b={},c=function(){},d=Backbone.View.extend({className:"inner",events:{},initalize:function(){},render:function(){var a=_.template($("#template-facet-settings-"+this.model.get("name")).html())({model:this.model});return this.$el.empty(),this.$el.append(a),this.$el}});return a.search=new LUCID.Models.Facet({name:"search",title:"Search",currentValue:"",description:"",active:!0}),b.search=Backbone.View.extend({el:".search",events:{"change .search-query":"updateInput"},initialize:function(){this.$searchInput=$("#facet-search")},render:function(){var a=this;this.$searchInput.autocomplete({source:function(a,b){$.ajax({url:"search_lookahead/",dataType:"json",data:{term:a.term},success:function(a){b($.map(a.terms,function(a){return{label:a,value:a}}))}})},minLength:2,select:function(b,c){a.model.set({currentValue:c.item.value})}})},updateInput:function(a){this.model.set({currentValue:this.$searchInput.val()})}}),a.date=new LUCID.Models.Facet({name:"date",title:"Date Range",currentValue:"",description:"Limits search results by a range of dates",active:!0}),b.date=Backbone.View.extend({className:"inner",events:{"change #facet-date-begin":"changeDate","change #facet-date-end":"changeDate"},initalize:function(){},render:function(){var a=this,b=_.template($("#template-facet-settings-"+this.model.get("name")).html())({model:this.model});return this.$el.empty(),this.$el.append(b),$("input.date",this.$el).datetimepicker({changeMonth:!0,changeYear:!0}),this.$el},getTimes:function(){var a,b,c,d;return a=$("#facet-date-begin").val()||0,c=(new Date(a)).getTime()/1e3,b=$("#facet-date-end").val()||0,d=(new Date(b)).getTime()/1e3,{start:c,end:d}},changeDate:function(){var a=this.getTimes(),b="";a.start<1?b+="Beginning of Time":b+=$.datepicker.formatDate("yy-mm-dd",new Date(a.start*1e3)),b+=" until ",a.end<1?b+="End of Time":b+=$.datepicker.formatDate("yy-mm-dd",new Date(a.end*1e3)),this.model.set({currentValue:""+a.start+","+a.end,breadCrumbTitle:b})}}),a.categories=new LUCID.Models.Facet({name:"categories",title:"Categories",currentValue:"",description:"Limits search results by category",active:!0,fields:{Odin:{active:!1,count:0},Thor:{active:!1,count:0},Loki:{active:!1,count:0},Heimdall:{active:!1,count:0},Vidar:{active:!1,count:0},Njord:{active:!1,count:0}}}),b.categories=Backbone.View.extend({className:"inner",events:{},initialize:function(){this.model.on("change:fields",this.updateListElements,this),this.model.on("fetchedFields",this.updateFieldCount,this)},generateFieldHtml:function(){var a=this.model.get("fields"),b=[],c;for(c in a)a.hasOwnProperty(c)&&b.push("<li><span class='field-wrapper name-"+c.toLowerCase().replace(/[^a-z]/gi,"")+"'>"+c+"<span class='count'>("+a[c].count+")</span></span></li>");return b=b.join(""),b},updateFieldCount:function(){var a=this.model.get("fields"),b=[],c;for(c in a)a.hasOwnProperty(c)&&$(".field-wrapper.name-"+c.toLowerCase().replace(/[^a-z]/gi,"")+" .count").html("("+a[c].count+")")},render:function(){var a=this,b=this.generateFieldHtml(),c=_.template($("#template-facet-settings-"+this.model.get("name")).html())({model:this.model,fields:b});return this.$el.empty(),this.$el.append(c),$("li",this.$el).click(function(b){var c=a.model.get("fields"),d,e=$(b.currentTarget);d=$(".field-wrapper",e).html().match(/\w*/)[0],c[d].active===!0?c[d].active=!1:c[d].active=!0,a.model.set({fields:c},{silent:!0}),a.model.trigger("change:fields"),a.updateListElements()}),this.$el},updateListElements:function(){var a=this.model.get("fields");$("li",this.$el).each(function(b,c){var d=$(".field-wrapper",c).html().match(/\w*/)[0],e="";a[d].active===!0?$(c).addClass("active"):$(c).removeClass("active")})}}),a.topics=new LUCID.Models.Facet({name:"topics",title:"Topics",currentValue:"",description:"Limits search results by topic",active:!0,fields:{Auto:{active:!1,count:0},Business:{active:!1,count:0},Communication:{active:!1,count:0},Electronics:{active:!1,count:0},Internet:{active:!1,count:0},Television:{active:!1,count:0}}}),b.topics=Backbone.View.extend({className:"inner",events:{},initialize:b.categories.prototype.initialize,generateFieldHtml:b.categories.prototype.generateFieldHtml,render:b.categories.prototype.render,updateListElements:b.categories.prototype.updateListElements,updateFieldCount:b.categories.prototype.updateFieldCount}),c=function(a){var c;return b[a.get("name")]?c=new(b[a.get("name")])({model:a}):c=new d({model:a}),c},{models:a,viewFactory:c,views:b}}(),LUCID.Views.BreadCrumb=Backbone.View.extend({tagName:"div",className:"bread-crumb-wrapper",events:{"click .close":"closeBreadCrumb"},initialize:function(){this.model.on("render:breadcrumb",this.render,this),this.model.on("change",this.render,this),this.model.on("change:fields",this.render,this)},render:function(){var a=[],b,c,d,e;this.$el.empty();if(this.model.get("currentValue")){c=this.model.get("fields");if(c===undefined||c===[])c={},d=this.model.get("breadCrumbTitle")||this.model.get("currentValue"),c[d]={active:!0,count:this.model.get("numResults")};for(b in c)c.hasOwnProperty(b)&&(console.log(b),c[b].active&&a.push('<span class="value-title">'+b+"</span>"));a=a.join(","),e=_.template($("#template-bread-crumb").html())({crumbs:a,model:this.model}),this.$el.append($(e))}return this.$el},closeBreadCrumb:function(){this.model.deactivateFields()}}),LUCID.Views.BreadCrumbs=Backbone.View.extend({el:".bread-crumbs-wrapper",events:{},views:{},initialize:function(){return this.collection.on("add",this.createViews,this),this},render:function(){var a,b={};for(a in this.views)this.views.hasOwnProperty(a)&&this.$el.append(this.views[a].render());return this},createViews:function(a){var b=new LUCID.Views.BreadCrumb({model:a});this.views["view_"+a.cid]=b,this.$el.append(b.render())}}),LUCID.init=function(){LUCID.app=new LUCID.Models.App({}),LUCID.appView=new LUCID.Views.App({model:LUCID.app});var a=new LUCID.Views.BreadCrumbs({collection:LUCID.app.get("facets")});a.render();var b=new LUCID.Views.Facets({collection:LUCID.app.get("facets")});b.render();var c=new LUCID.Views.DataItems({collection:LUCID.app.get("dataItems")});c.render(),LUCID.appView.render()};